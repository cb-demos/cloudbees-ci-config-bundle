import jenkins.model.*;
import org.jenkinsci.plugins.workflow.libs.*;
import jenkins.scm.api.SCMSource;
import jenkins.plugins.git.*; 
import com.cloudbees.pipeline.governance.templates.*;
import com.cloudbees.pipeline.governance.templates.catalog.*;
import org.jenkinsci.plugins.github.GitHubPlugin;
import java.util.logging.Logger;

Logger logger = Logger.getLogger("create-pipeline-template-catalog.groovy");

def jenkins = Jenkins.instance
def name = "microblog-frontend"
def microBlogJob = jenkins.getItemByFullName(name)
if (microBlogJob == null) {
  //Pipeline Template Catalog
  SCMSource scm = new GitSCMSource("https://github.com/REPLACE_GITHUB_ORG/pipeline-template-catalog.git");
  scm.setCredentialsId("github-sa");
  TemplateCatalog catalog = new TemplateCatalog(scm, "master");
  catalog.setUpdateInterval("1h");
  GlobalTemplateCatalogManagement.get().addCatalog(catalog);
  GlobalTemplateCatalogManagement.get().save();
  logger.info("Creating new Pipeline Template Catalog");
  catalog.updateFromSCM(); 

  //microblog-fronted job from Pipeline Template
  def frontendJobXml = """
  <org.jenkinsci.plugins.workflow.multibranch.WorkflowMultiBranchProject plugin="workflow-multibranch@2.21">
    <properties>
      <com.cloudbees.pipeline.governance.templates.classic.multibranch.GovernanceMultibranchPipelinePropertyImpl plugin="cloudbees-workflow-template@3.7">
        <instance>
          <model>cb-demo/vuejs-app</model>
          <values class="tree-map">
            <entry>
              <string>gcpProject</string>
              <string>core-flow-research</string>
            </entry>
            <entry>
              <string>githubCredentialId</string>
              <string>github-sa</string>
            </entry>
            <entry>
              <string>name</string>
              <string>microblog-frontend</string>
            </entry>
            <entry>
              <string>registry</string>
              <string>gcr.io/core-flow-research</string>
            </entry>
            <entry>
              <string>repoOwner</string>
              <string>REPLACE_GITHUB_ORG</string>
            </entry>
            <entry>
              <string>repository</string>
              <string>microblog-frontend</string>
            </entry>
          </values>
        </instance>
      </com.cloudbees.pipeline.governance.templates.classic.multibranch.GovernanceMultibranchPipelinePropertyImpl>
    </properties>
    <folderViews class="jenkins.branch.MultiBranchProjectViewHolder" plugin="branch-api@2.5.6">
      <owner class="org.jenkinsci.plugins.workflow.multibranch.WorkflowMultiBranchProject" reference="../.."/>
    </folderViews>
    <healthMetrics>
      <com.cloudbees.hudson.plugins.folder.health.WorstChildHealthMetric plugin="cloudbees-folder@6.14">
        <nonRecursive>false</nonRecursive>
      </com.cloudbees.hudson.plugins.folder.health.WorstChildHealthMetric>
      <com.cloudbees.hudson.plugins.folder.health.AverageChildHealthMetric plugin="cloudbees-folders-plus@3.10"/>
      <com.cloudbees.hudson.plugins.folder.health.JobStatusHealthMetric plugin="cloudbees-folders-plus@3.10">
        <success>true</success>
        <failure>true</failure>
        <unstable>true</unstable>
        <unbuilt>true</unbuilt>
        <countVirginJobs>false</countVirginJobs>
      </com.cloudbees.hudson.plugins.folder.health.JobStatusHealthMetric>
      <com.cloudbees.hudson.plugins.folder.health.ProjectEnabledHealthMetric plugin="cloudbees-folders-plus@3.10"/>
    </healthMetrics>
    <icon class="jenkins.branch.MetadataActionFolderIcon" plugin="branch-api@2.5.6">
      <owner class="org.jenkinsci.plugins.workflow.multibranch.WorkflowMultiBranchProject" reference="../.."/>
    </icon>
    <orphanedItemStrategy class="com.cloudbees.hudson.plugins.folder.computed.DefaultOrphanedItemStrategy" plugin="cloudbees-folder@6.14">
      <pruneDeadBranches>true</pruneDeadBranches>
      <daysToKeep>-1</daysToKeep>
      <numToKeep>-1</numToKeep>
    </orphanedItemStrategy>
    <triggers>
      <com.cloudbees.hudson.plugins.folder.computed.PeriodicFolderTrigger plugin="cloudbees-folder@6.14">
        <spec>H H/4 * * *</spec>
        <interval>86400000</interval>
      </com.cloudbees.hudson.plugins.folder.computed.PeriodicFolderTrigger>
    </triggers>
    <disabled>false</disabled>
    <sources>
      <jenkins.branch.BranchSource plugin="branch-api@2.5.6">
        <source class="org.jenkinsci.plugins.github_branch_source.GitHubSCMSource" plugin="github-branch-source@2.8.2">
          <id>VueJS</id>
          <apiUri>https://api.github.com</apiUri>
          <credentialsId>github-sa</credentialsId>
          <repoOwner>REPLACE_GITHUB_ORG</repoOwner>
          <repository>microblog-frontend</repository>
          <traits>
            <org.jenkinsci.plugins.github__branch__source.BranchDiscoveryTrait>
              <strategyId>1</strategyId>
            </org.jenkinsci.plugins.github__branch__source.BranchDiscoveryTrait>
            <org.jenkinsci.plugins.github__branch__source.OriginPullRequestDiscoveryTrait>
              <strategyId>1</strategyId>
            </org.jenkinsci.plugins.github__branch__source.OriginPullRequestDiscoveryTrait>
            <org.jenkinsci.plugins.github__branch__source.ForkPullRequestDiscoveryTrait>
              <strategyId>1</strategyId>
              <trust class="org.jenkinsci.plugins.github_branch_source.ForkPullRequestDiscoveryTrait$TrustPermission"/>
            </org.jenkinsci.plugins.github__branch__source.ForkPullRequestDiscoveryTrait>
          </traits>
        </source>
      </jenkins.branch.BranchSource>
    </sources>
    <factory class="com.cloudbees.pipeline.governance.templates.classic.multibranch.FromTemplateBranchProjectFactory" plugin="cloudbees-workflow-template@3.7">
      <owner class="org.jenkinsci.plugins.workflow.multibranch.WorkflowMultiBranchProject" reference="../.."/>
      <catalogName>workshopCatalog</catalogName>
      <templateDirectory>vuejs-app</templateDirectory>
    </factory>
  </org.jenkinsci.plugins.workflow.multibranch.WorkflowMultiBranchProject>
  """

  def p = jenkins.createProjectFromXML(name, new ByteArrayInputStream(frontendJobXml.getBytes("UTF-8")));

  logger.info("created $name job")
  
  //microblog-backend job from Pipeline Template
  def backendJobXml = """
  <org.jenkinsci.plugins.workflow.multibranch.WorkflowMultiBranchProject plugin="workflow-multibranch@2.21">
    <properties>
      <com.cloudbees.pipeline.governance.templates.classic.multibranch.GovernanceMultibranchPipelinePropertyImpl plugin="cloudbees-workflow-template@3.7">
        <instance>
          <model>workshopCatalog/python</model>
          <values class="tree-map">
            <entry>
              <string>gcpProject</string>
              <string>core-flow-research</string>
            </entry>
            <entry>
              <string>githubCredentialId</string>
              <string>github-sa</string>
            </entry>
            <entry>
              <string>name</string>
              <string>microblog-backend</string>
            </entry>
            <entry>
              <string>repoOwner</string>
              <string>REPLACE_GITHUB_ORG</string>
            </entry>
            <entry>
              <string>repository</string>
              <string>microblog-backend</string>
            </entry>
          </values>
        </instance>
      </com.cloudbees.pipeline.governance.templates.classic.multibranch.GovernanceMultibranchPipelinePropertyImpl>
    </properties>
    <folderViews class="jenkins.branch.MultiBranchProjectViewHolder" plugin="branch-api@2.5.6">
      <owner class="org.jenkinsci.plugins.workflow.multibranch.WorkflowMultiBranchProject" reference="../.."/>
    </folderViews>
    <healthMetrics>
      <com.cloudbees.hudson.plugins.folder.health.WorstChildHealthMetric plugin="cloudbees-folder@6.14">
        <nonRecursive>false</nonRecursive>
      </com.cloudbees.hudson.plugins.folder.health.WorstChildHealthMetric>
      <com.cloudbees.hudson.plugins.folder.health.AverageChildHealthMetric plugin="cloudbees-folders-plus@3.10"/>
      <com.cloudbees.hudson.plugins.folder.health.JobStatusHealthMetric plugin="cloudbees-folders-plus@3.10">
        <success>true</success>
        <failure>true</failure>
        <unstable>true</unstable>
        <unbuilt>true</unbuilt>
        <countVirginJobs>false</countVirginJobs>
      </com.cloudbees.hudson.plugins.folder.health.JobStatusHealthMetric>
      <com.cloudbees.hudson.plugins.folder.health.ProjectEnabledHealthMetric plugin="cloudbees-folders-plus@3.10"/>
    </healthMetrics>
    <icon class="jenkins.branch.MetadataActionFolderIcon" plugin="branch-api@2.5.6">
      <owner class="org.jenkinsci.plugins.workflow.multibranch.WorkflowMultiBranchProject" reference="../.."/>
    </icon>
    <orphanedItemStrategy class="com.cloudbees.hudson.plugins.folder.computed.DefaultOrphanedItemStrategy" plugin="cloudbees-folder@6.14">
      <pruneDeadBranches>true</pruneDeadBranches>
      <daysToKeep>-1</daysToKeep>
      <numToKeep>-1</numToKeep>
    </orphanedItemStrategy>
    <triggers>
      <com.cloudbees.hudson.plugins.folder.computed.PeriodicFolderTrigger plugin="cloudbees-folder@6.14">
        <spec>H H/4 * * *</spec>
        <interval>86400000</interval>
      </com.cloudbees.hudson.plugins.folder.computed.PeriodicFolderTrigger>
    </triggers>
    <disabled>false</disabled>
    <sources>
      <jenkins.branch.BranchSource plugin="branch-api@2.5.6">
        <source class="org.jenkinsci.plugins.github_branch_source.GitHubSCMSource" plugin="github-branch-source@2.8.2">
          <id>Python</id>
          <apiUri>https://api.github.com</apiUri>
          <credentialsId>github-sa</credentialsId>
          <repoOwner>REPLACE_GITHUB_ORG</repoOwner>
          <repository>microblog-backend</repository>
          <traits>
            <org.jenkinsci.plugins.github__branch__source.BranchDiscoveryTrait>
              <strategyId>1</strategyId>
            </org.jenkinsci.plugins.github__branch__source.BranchDiscoveryTrait>
            <org.jenkinsci.plugins.github__branch__source.OriginPullRequestDiscoveryTrait>
              <strategyId>1</strategyId>
            </org.jenkinsci.plugins.github__branch__source.OriginPullRequestDiscoveryTrait>
            <org.jenkinsci.plugins.github__branch__source.ForkPullRequestDiscoveryTrait>
              <strategyId>1</strategyId>
              <trust class="org.jenkinsci.plugins.github_branch_source.ForkPullRequestDiscoveryTrait$TrustPermission"/>
            </org.jenkinsci.plugins.github__branch__source.ForkPullRequestDiscoveryTrait>
          </traits>
        </source>
      </jenkins.branch.BranchSource>
    </sources>
    <factory class="com.cloudbees.pipeline.governance.templates.classic.multibranch.FromTemplateBranchProjectFactory" plugin="cloudbees-workflow-template@3.7">
      <owner class="org.jenkinsci.plugins.workflow.multibranch.WorkflowMultiBranchProject" reference="../.."/>
      <catalogName>workshopCatalog</catalogName>
      <templateDirectory>python</templateDirectory>
    </factory>
  </org.jenkinsci.plugins.workflow.multibranch.WorkflowMultiBranchProject>
  """

  def backendProject = jenkins.createProjectFromXML(name, new ByteArrayInputStream(backendJobXml.getBytes("UTF-8")));

  logger.info("created $backendJob job")  
  
} else {
  logger.info("$name job already exists")
}
